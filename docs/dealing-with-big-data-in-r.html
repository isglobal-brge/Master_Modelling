<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>2 Dealing with Big Data in R | Data Visualisation and Modelling</title>
  <meta name="description" content="2 Dealing with Big Data in R | Data Visualisation and Modelling" />
  <meta name="generator" content="bookdown 0.23 and GitBook 2.6.7" />

  <meta property="og:title" content="2 Dealing with Big Data in R | Data Visualisation and Modelling" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="2 Dealing with Big Data in R | Data Visualisation and Modelling" />
  
  
  

<meta name="author" content="Juan R González" />


<meta name="date" content="2021-10-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="linear-models.html"/>
<script src="libs/header-attrs-2.10/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Data Visualisation and Modelling</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introducción</a></li>
<li class="chapter" data-level="2" data-path="dealing-with-big-data-in-r.html"><a href="dealing-with-big-data-in-r.html"><i class="fa fa-check"></i><b>2</b> Dealing with Big Data in R</a>
<ul>
<li class="chapter" data-level="2.1" data-path="dealing-with-big-data-in-r.html"><a href="dealing-with-big-data-in-r.html#nodes-cores-processes-and-threads"><i class="fa fa-check"></i><b>2.1</b> Nodes, cores, processes and threads</a></li>
<li class="chapter" data-level="2.2" data-path="dealing-with-big-data-in-r.html"><a href="dealing-with-big-data-in-r.html#paralelización"><i class="fa fa-check"></i><b>2.2</b> Paralelización</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="dealing-with-big-data-in-r.html"><a href="dealing-with-big-data-in-r.html#shared-memory-programming"><i class="fa fa-check"></i><b>2.2.1</b> Shared Memory Programming</a></li>
<li class="chapter" data-level="2.2.2" data-path="dealing-with-big-data-in-r.html"><a href="dealing-with-big-data-in-r.html#distributed-memory-programming"><i class="fa fa-check"></i><b>2.2.2</b> Distributed Memory Programming</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="dealing-with-big-data-in-r.html"><a href="dealing-with-big-data-in-r.html#mapreduce"><i class="fa fa-check"></i><b>2.3</b> MapReduce</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="dealing-with-big-data-in-r.html"><a href="dealing-with-big-data-in-r.html#map"><i class="fa fa-check"></i><b>2.3.1</b> Map</a></li>
<li class="chapter" data-level="2.3.2" data-path="dealing-with-big-data-in-r.html"><a href="dealing-with-big-data-in-r.html#reduce"><i class="fa fa-check"></i><b>2.3.2</b> Reduce</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="dealing-with-big-data-in-r.html"><a href="dealing-with-big-data-in-r.html#linear-regression-for-big-data"><i class="fa fa-check"></i><b>2.4</b> Linear regression for Big Data</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="linear-models.html"><a href="linear-models.html"><i class="fa fa-check"></i><b>3</b> Linear models</a>
<ul>
<li class="chapter" data-level="3.1" data-path="linear-models.html"><a href="linear-models.html#ols-estimation-in-r"><i class="fa fa-check"></i><b>3.1</b> OLS estimation in R</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html"><i class="fa fa-check"></i><b>4</b> Generalized linear models</a>
<ul>
<li class="chapter" data-level="4.1" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#logistic-regression-with-r"><i class="fa fa-check"></i><b>4.1</b> Logistic regression with R</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="model-fitting.html"><a href="model-fitting.html"><i class="fa fa-check"></i><b>5</b> Model Fitting</a>
<ul>
<li class="chapter" data-level="5.1" data-path="model-fitting.html"><a href="model-fitting.html#getting-started"><i class="fa fa-check"></i><b>5.1</b> Getting started</a></li>
<li class="chapter" data-level="5.2" data-path="model-fitting.html"><a href="model-fitting.html#general-rules-for-variable-selection"><i class="fa fa-check"></i><b>5.2</b> General rules for variable selection</a></li>
<li class="chapter" data-level="5.3" data-path="model-fitting.html"><a href="model-fitting.html#stepwise-variable-selection"><i class="fa fa-check"></i><b>5.3</b> Stepwise variable selection</a></li>
<li class="chapter" data-level="5.4" data-path="model-fitting.html"><a href="model-fitting.html#comparing-models"><i class="fa fa-check"></i><b>5.4</b> Comparing models</a></li>
<li class="chapter" data-level="5.5" data-path="model-fitting.html"><a href="model-fitting.html#automatic-variable-selection"><i class="fa fa-check"></i><b>5.5</b> Automatic variable selection</a></li>
<li class="chapter" data-level="5.6" data-path="model-fitting.html"><a href="model-fitting.html#cross-validation"><i class="fa fa-check"></i><b>5.6</b> Cross validation</a></li>
<li class="chapter" data-level="5.7" data-path="model-fitting.html"><a href="model-fitting.html#cross-validation-and-bootstrap"><i class="fa fa-check"></i><b>5.7</b> Cross-validation and Bootstrap</a>
<ul>
<li class="chapter" data-level="5.7.1" data-path="model-fitting.html"><a href="model-fitting.html#leave-one-out-cross-validation-loocv"><i class="fa fa-check"></i><b>5.7.1</b> Leave-one-out cross validation (LOOCV)</a></li>
<li class="chapter" data-level="5.7.2" data-path="model-fitting.html"><a href="model-fitting.html#k-fold-cross-validation-k-fold-cv"><i class="fa fa-check"></i><b>5.7.2</b> K-fold cross validation (K-fold CV)</a></li>
<li class="chapter" data-level="5.7.3" data-path="model-fitting.html"><a href="model-fitting.html#bootstrap"><i class="fa fa-check"></i><b>5.7.3</b> Bootstrap</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="model-fitting.html"><a href="model-fitting.html#example-with-caret-library"><i class="fa fa-check"></i><b>5.8</b> Example with <code>caret</code> library</a></li>
<li class="chapter" data-level="5.9" data-path="model-fitting.html"><a href="model-fitting.html#missing-data-imputation"><i class="fa fa-check"></i><b>5.9</b> Missing data imputation</a></li>
<li class="chapter" data-level="5.10" data-path="model-fitting.html"><a href="model-fitting.html#regularization"><i class="fa fa-check"></i><b>5.10</b> Regularization</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="datashield.html"><a href="datashield.html"><i class="fa fa-check"></i><b>6</b> DataSHIELD</a></li>
<li class="chapter" data-level="7" data-path="opal.html"><a href="opal.html"><i class="fa fa-check"></i><b>7</b> Opal</a>
<ul>
<li class="chapter" data-level="7.1" data-path="opal.html"><a href="opal.html#introduction"><i class="fa fa-check"></i><b>7.1</b> Introduction</a></li>
<li class="chapter" data-level="7.2" data-path="opal.html"><a href="opal.html#data-management"><i class="fa fa-check"></i><b>7.2</b> Data Management</a></li>
<li class="chapter" data-level="7.3" data-path="opal.html"><a href="opal.html#security"><i class="fa fa-check"></i><b>7.3</b> Security</a></li>
<li class="chapter" data-level="7.4" data-path="opal.html"><a href="opal.html#r-integration"><i class="fa fa-check"></i><b>7.4</b> R Integration</a></li>
<li class="chapter" data-level="7.5" data-path="opal.html"><a href="opal.html#opal-demo-site"><i class="fa fa-check"></i><b>7.5</b> Opal demo site</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Data Visualisation and Modelling</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="dealing-with-big-data-in-r" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Dealing with Big Data in R</h1>
<p>In the era of big data, we can have access to large volumes of data obtained from our population of interest. Traditional algorithms implemented for even the simplest statistical methods (descriptive, linear regression, …) require a lot of computing time. To address this issue, one of the approaches we have is to divide our data into smaller sets that do not require as much computational cost and to combine these results in a clever way that allows us to solve the largest problem. This can be done by parallelizing the calculations since even laptops already have multiple computing cores, and/or combining the calculations with paradigms such as <em>MapReduce</em> that has been designed to deal with Big Data efficiently. In this section we will learn how to:</p>
<ul>
<li>Parallelize in R</li>
<li>Use MapReduce</li>
<li>Implement multiple linear regression in a distributed system using MapReduce paradigm</li>
</ul>
<div id="nodes-cores-processes-and-threads" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Nodes, cores, processes and threads</h2>
<p>The terminology of nodes, cores, processes and threads is not universal. Depending on the computer, software (etc.), they can have various meanings. Typical examples: socket instead of node; cpu instead of core; task instead of process. Supercomputers have complex architectures, mainly due to their processors capability to work together on the same memory space. More precisely, the smallest computing units, called cores, are grouped in nodes. All the cores in one node share the same memory space. In other terms, the cores of the same node can operate on the same data, at the same time; no need for sending the data back and forth. This hardware architecture is summarized in this figure that shows a simple schematic of a 16-core node. The node contains two CPUs and each CPU consists of 8 cores. The schematic also shows the attached memory and the connections between the CPUs and memory.</p>
<div class="figure">
<img src="figures/hpc_node-cpu-core.png" style="width:50.0%" alt="" />
<p class="caption">Nodes, cores and processors</p>
</div>
<p><strong>Nodes</strong>: Refers to the physical machine/server. In current systems, a node would typically include one or more processors, as well as memory and other hardware.</p>
<p><strong>Processor</strong>: Refers to the central processing unit (CPU), which contains one or more cores.</p>
<p><strong>Cores</strong>: Refers to the basic computation unit of the CPU. This is unit that carries out the actual computations.</p>
<p>So in essence, each compute node contains one or more processors/CPUs and each CPU will typically consist of one or more cores.</p>
</div>
<div id="paralelización" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Paralelización</h2>
<p>When using a single CPU, or serial computing, the problem size is limited by the available memory and performance. As data sizes become larger and systems become more complex, programs/applications rapidly run out of resources. Effectively utilising parallel computing can overcome these limitations. Parallel computing has become essential to solving big problems (high resolution, lots of timesteps, etc.) in science and engineering.</p>
<p>Parallel computing can be simply defined as the simultaneous use of multiple processors/computers, i.e. parallel computers, to solve a computational problem. The general pattern is:</p>
<ul>
<li>The problem is broken down into discrete sections or separate tasks.</li>
<li>Each processor works on its task or section of the problem. With multiple processors this means that several tasks can be processed at any given time.</li>
<li>Processors exchange information with other processors, when required.</li>
</ul>
<p>It allows leveraging the resources of multiple processors/computers, increasing the resources available to the application/software. This enables the execution of tasks that do not fit on a single CPU and the completion of the tasks in a reasonable time. This has many benefits. For instance, we can add more data points which can translate to the use of bigger domains, improved spatial resolution or the inclusion of more particles in a simulation. Faster execution time can translate to increased number of solutions in a given time or a faster time to solution.</p>
<div id="shared-memory-programming" class="section level3" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> Shared Memory Programming</h3>
<p>Parallel programming for shared memory machines is easier since the all cores have access to the same memory address space and so all have access to the same data structures. This greatly simplifies the task of parallelisation. Use can be made of auto-parallelisation via compiler options, loop-level parallelism through compiler directives or OpenMP. On the other hand, speedup and scalability are limited by the number of cores in the shared memory machine, and this is generally a relatively small number. In addition, code can only be used on a shared memory machine.</p>
</div>
<div id="distributed-memory-programming" class="section level3" number="2.2.2">
<h3><span class="header-section-number">2.2.2</span> Distributed Memory Programming</h3>
<p>Programming for distributed memory machines provides a means to take advantage of more resources than those available on a shared memory machine. In addition, code developed for distributed memory machines can be used on shared memory machines. However, this type of programming is generally more difficult than shared memory programming. Since each processor only has access to its local memory, the programmer is responsible for mapping data structures across the separate nodes. In addition, there is a need to coordinate the communications between nodes, i.e. message passing, to ensure that a node can access remote data when it is needed for a local computation. The standard library used for this is MPI.</p>
<p>Next figure illustrate the difference between both approaches</p>
<div class="figure">
<img src="figures/shared_distributed_memory.jpg" style="width:70.0%" alt="" />
<p class="caption">Memory Organization: (a) Shared Memory, (b) Distributed Memory</p>
</div>
<p>Doing these tasks in R without strong knowledge in informatics can be hard. However, there are several R packages to perform parallel computing. The reason for using <code>doParallel</code> package, and not <code>parallel</code>, is that the <code>parallel</code> package is not working entirely on Windows and you had to write different code for it to work. The <code>doParallel</code> package is trying to make it happen on all platforms: UNIX, LINUX and WINDOWS, so it’s a pretty decent wrapper. To me, the most simple way of doing parallelization is to use <code>mclapply()</code> function from <code>parallel</code> but this cannot be used in Window.</p>
<p>Let us assume we want to compute <span class="math inline">\(f(x)=x^2 + x\)</span> of 10 numbers stored in a vector called <code>vec</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="dealing-with-big-data-in-r.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb1-2"><a href="dealing-with-big-data-in-r.html#cb1-2" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x) x<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> x</span>
<span id="cb1-3"><a href="dealing-with-big-data-in-r.html#cb1-3" aria-hidden="true" tabindex="-1"></a>vec <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="dv">10</span>, <span class="at">lambda=</span><span class="dv">200</span>)</span></code></pre></div>
<p>We can do the following strategies:</p>
<ol style="list-style-type: decimal">
<li>Looping</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="dealing-with-big-data-in-r.html#cb2-1" aria-hidden="true" tabindex="-1"></a>forFunction <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {  </span>
<span id="cb2-2"><a href="dealing-with-big-data-in-r.html#cb2-2" aria-hidden="true" tabindex="-1"></a>  ans <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(x))</span>
<span id="cb2-3"><a href="dealing-with-big-data-in-r.html#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> vec)</span>
<span id="cb2-4"><a href="dealing-with-big-data-in-r.html#cb2-4" aria-hidden="true" tabindex="-1"></a>   {</span>
<span id="cb2-5"><a href="dealing-with-big-data-in-r.html#cb2-5" aria-hidden="true" tabindex="-1"></a>    ans[i] <span class="ot">&lt;-</span> <span class="fu">f</span>(i)</span>
<span id="cb2-6"><a href="dealing-with-big-data-in-r.html#cb2-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-7"><a href="dealing-with-big-data-in-r.html#cb2-7" aria-hidden="true" tabindex="-1"></a>  ans</span>
<span id="cb2-8"><a href="dealing-with-big-data-in-r.html#cb2-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Using <code>lapply ()</code> or <code>sapply ()</code> function</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="dealing-with-big-data-in-r.html#cb3-1" aria-hidden="true" tabindex="-1"></a>lapplyFunction <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb3-2"><a href="dealing-with-big-data-in-r.html#cb3-2" aria-hidden="true" tabindex="-1"></a>  ans <span class="ot">&lt;-</span> <span class="fu">sapply</span>(x, f)</span>
<span id="cb3-3"><a href="dealing-with-big-data-in-r.html#cb3-3" aria-hidden="true" tabindex="-1"></a>  ans</span>
<span id="cb3-4"><a href="dealing-with-big-data-in-r.html#cb3-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Using <code>doParallel::parLapply()</code> function</li>
</ol>
<p>We need first to create the cluster</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="dealing-with-big-data-in-r.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb4-2"><a href="dealing-with-big-data-in-r.html#cb4-2" aria-hidden="true" tabindex="-1"></a>ncores <span class="ot">&lt;-</span> <span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span>  </span>
<span id="cb4-3"><a href="dealing-with-big-data-in-r.html#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(<span class="at">cores=</span>ncores)  </span>
<span id="cb4-4"><a href="dealing-with-big-data-in-r.html#cb4-4" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(ncores) </span></code></pre></div>
<p>Then, we can use the parallel implementation of <code>lapply</code></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="dealing-with-big-data-in-r.html#cb5-1" aria-hidden="true" tabindex="-1"></a>parLapplyFunction <span class="ot">&lt;-</span> <span class="cf">function</span>(cl, x, f){</span>
<span id="cb5-2"><a href="dealing-with-big-data-in-r.html#cb5-2" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">parLapply</span>(<span class="at">cl=</span>cl, <span class="at">X=</span>x, <span class="at">fun=</span>f)  </span>
<span id="cb5-3"><a href="dealing-with-big-data-in-r.html#cb5-3" aria-hidden="true" tabindex="-1"></a>  result</span>
<span id="cb5-4"><a href="dealing-with-big-data-in-r.html#cb5-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Using <code>doParallel::foreach()</code> function</li>
</ol>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="dealing-with-big-data-in-r.html#cb6-1" aria-hidden="true" tabindex="-1"></a>foreachDoParFunction <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb6-2"><a href="dealing-with-big-data-in-r.html#cb6-2" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i=</span>x, <span class="at">.export=</span><span class="st">&quot;f&quot;</span>) <span class="sc">%dopar%</span> <span class="fu">f</span>(i)</span>
<span id="cb6-3"><a href="dealing-with-big-data-in-r.html#cb6-3" aria-hidden="true" tabindex="-1"></a>  result</span>
<span id="cb6-4"><a href="dealing-with-big-data-in-r.html#cb6-4" aria-hidden="true" tabindex="-1"></a>}  </span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="dealing-with-big-data-in-r.html#cb7-1" aria-hidden="true" tabindex="-1"></a>foreachDoFunction <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb7-2"><a href="dealing-with-big-data-in-r.html#cb7-2" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i=</span>x, <span class="at">.export=</span><span class="st">&quot;f&quot;</span>) <span class="sc">%do%</span> <span class="fu">f</span>(i)</span>
<span id="cb7-3"><a href="dealing-with-big-data-in-r.html#cb7-3" aria-hidden="true" tabindex="-1"></a>  result</span>
<span id="cb7-4"><a href="dealing-with-big-data-in-r.html#cb7-4" aria-hidden="true" tabindex="-1"></a>}  </span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Using <code>parallel::mclapply()</code> function</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="dealing-with-big-data-in-r.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Only works in Linux (Windows ncores must be set equal to 1)</span></span>
<span id="cb8-2"><a href="dealing-with-big-data-in-r.html#cb8-2" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">mclapply</span>(x, f, <span class="at">mc.cores=</span>ncores)</span></code></pre></div>
<p>In order to compare computation time, we can run</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="dealing-with-big-data-in-r.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(result <span class="ot">&lt;-</span> <span class="fu">lapply</span>(vec, f))</span></code></pre></div>
<pre><code>   user  system elapsed 
   0.02    0.00    0.02 </code></pre>
<p>Nonetheless, <code>rbenchmark</code> function serves as a more accurate replacement of the often seen <code>system.time()</code> function and the more sophisticated <code>system.time(replicate(1000, expr))</code> expression (that incorporates variability). It tries hard to accurately measure only the time it takes to evaluate expr. To achieved this, the sub-millisecond (supposedly nanosecond) accurate timing functions most modern operating systems provide are used. Additionally all evaluations of the expressions are done in C code to minimize any overhead. In our example:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="dealing-with-big-data-in-r.html#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rbenchmark)</span>
<span id="cb11-2"><a href="dealing-with-big-data-in-r.html#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb11-3"><a href="dealing-with-big-data-in-r.html#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="dealing-with-big-data-in-r.html#cb11-4" aria-hidden="true" tabindex="-1"></a>ncores <span class="ot">&lt;-</span> <span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span>  </span>
<span id="cb11-5"><a href="dealing-with-big-data-in-r.html#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(<span class="at">cores=</span>ncores)  </span>
<span id="cb11-6"><a href="dealing-with-big-data-in-r.html#cb11-6" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(ncores) </span>
<span id="cb11-7"><a href="dealing-with-big-data-in-r.html#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="dealing-with-big-data-in-r.html#cb11-8" aria-hidden="true" tabindex="-1"></a>testdata1 <span class="ot">&lt;-</span> <span class="fu">benchmark</span>(<span class="st">&quot;For loop&quot;</span> <span class="ot">=</span> <span class="fu">forFunction</span>(vec),</span>
<span id="cb11-9"><a href="dealing-with-big-data-in-r.html#cb11-9" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;lapply&quot;</span> <span class="ot">=</span> <span class="fu">lapplyFunction</span>(vec),</span>
<span id="cb11-10"><a href="dealing-with-big-data-in-r.html#cb11-10" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;Foreach dopar&quot;</span> <span class="ot">=</span> <span class="fu">foreachDoParFunction</span>(vec),</span>
<span id="cb11-11"><a href="dealing-with-big-data-in-r.html#cb11-11" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;Foreach do&quot;</span> <span class="ot">=</span> <span class="fu">foreachDoFunction</span>(vec),</span>
<span id="cb11-12"><a href="dealing-with-big-data-in-r.html#cb11-12" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;parLapply&quot;</span> <span class="ot">=</span> <span class="fu">parLapplyFunction</span>(<span class="at">cl=</span>cl, <span class="at">x=</span>vec, <span class="at">f=</span>f),</span>
<span id="cb11-13"><a href="dealing-with-big-data-in-r.html#cb11-13" aria-hidden="true" tabindex="-1"></a>                      <span class="at">columns=</span><span class="fu">c</span>(<span class="st">&#39;test&#39;</span>, <span class="st">&#39;elapsed&#39;</span>, <span class="st">&#39;replications&#39;</span>),</span>
<span id="cb11-14"><a href="dealing-with-big-data-in-r.html#cb11-14" aria-hidden="true" tabindex="-1"></a>                      <span class="at">replications =</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>, <span class="dv">400</span>, <span class="dv">500</span>))</span>
<span id="cb11-15"><a href="dealing-with-big-data-in-r.html#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="dealing-with-big-data-in-r.html#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="dealing-with-big-data-in-r.html#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="dealing-with-big-data-in-r.html#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="dealing-with-big-data-in-r.html#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb11-20"><a href="dealing-with-big-data-in-r.html#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> replications, <span class="at">y =</span> elapsed, <span class="at">colour =</span> test), <span class="at">data =</span> testdata1)</span></code></pre></div>
<p><img src="fig/unnamed-chunk-4-1.png" width="672" /></p>
<p>Another example could be to compare the performance of the five methods for matrix multiplication</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="dealing-with-big-data-in-r.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb12-2"><a href="dealing-with-big-data-in-r.html#cb12-2" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">20</span>), <span class="at">nrow=</span><span class="dv">4</span>, <span class="at">ncol=</span><span class="dv">5</span>)</span>
<span id="cb12-3"><a href="dealing-with-big-data-in-r.html#cb12-3" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">20</span>), <span class="at">nrow=</span><span class="dv">4</span>, <span class="at">ncol=</span><span class="dv">5</span>)</span>
<span id="cb12-4"><a href="dealing-with-big-data-in-r.html#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="dealing-with-big-data-in-r.html#cb12-5" aria-hidden="true" tabindex="-1"></a>FUN <span class="ot">&lt;-</span> <span class="cf">function</span>(i, A, B){</span>
<span id="cb12-6"><a href="dealing-with-big-data-in-r.html#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossprod</span>(A,B)</span>
<span id="cb12-7"><a href="dealing-with-big-data-in-r.html#cb12-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-8"><a href="dealing-with-big-data-in-r.html#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="dealing-with-big-data-in-r.html#cb12-9" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb12-10"><a href="dealing-with-big-data-in-r.html#cb12-10" aria-hidden="true" tabindex="-1"></a>testdata2 <span class="ot">&lt;-</span> <span class="fu">benchmark</span>(<span class="st">&quot;For loop&quot;</span> <span class="ot">=</span> <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(a)){<span class="fu">FUN</span>(i, A, B)},</span>
<span id="cb12-11"><a href="dealing-with-big-data-in-r.html#cb12-11" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;lapply&quot;</span> <span class="ot">=</span> <span class="fu">lapply</span>(a, <span class="at">FUN =</span> FUN, <span class="at">A=</span>A, <span class="at">B=</span>B), </span>
<span id="cb12-12"><a href="dealing-with-big-data-in-r.html#cb12-12" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;Foreach dopar&quot;</span> <span class="ot">=</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">%dopar%</span> <span class="fu">FUN</span>(i, A, B),</span>
<span id="cb12-13"><a href="dealing-with-big-data-in-r.html#cb12-13" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;Foreach do&quot;</span> <span class="ot">=</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">%do%</span> <span class="fu">FUN</span>(i, A, B),</span>
<span id="cb12-14"><a href="dealing-with-big-data-in-r.html#cb12-14" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;parLapply&quot;</span> <span class="ot">=</span> <span class="fu">parLapply</span>(<span class="at">cl =</span> cl, <span class="at">X =</span> a, <span class="at">fun =</span> FUN, <span class="at">A=</span>A, <span class="at">B=</span>B),</span>
<span id="cb12-15"><a href="dealing-with-big-data-in-r.html#cb12-15" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;parSapply&quot;</span> <span class="ot">=</span> <span class="fu">parSapply</span>(<span class="at">cl =</span> cl, <span class="at">X =</span> a, <span class="at">FUN =</span> FUN, <span class="at">A=</span>A, <span class="at">B=</span>B),</span>
<span id="cb12-16"><a href="dealing-with-big-data-in-r.html#cb12-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">columns=</span><span class="fu">c</span>(<span class="st">&#39;test&#39;</span>, <span class="st">&#39;elapsed&#39;</span>, <span class="st">&#39;replications&#39;</span>),</span>
<span id="cb12-17"><a href="dealing-with-big-data-in-r.html#cb12-17" aria-hidden="true" tabindex="-1"></a>                       <span class="at">replications =</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>, <span class="dv">400</span>, <span class="dv">500</span>))</span>
<span id="cb12-18"><a href="dealing-with-big-data-in-r.html#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="dealing-with-big-data-in-r.html#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb12-20"><a href="dealing-with-big-data-in-r.html#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> replications, <span class="at">y =</span> elapsed, <span class="at">colour =</span> test), <span class="at">data =</span> testdata2)</span></code></pre></div>
<p><img src="fig/unnamed-chunk-5-1.png" width="672" /></p>
<p>Finally, we could also compare the performance of the five methods for fitting generalized linear model</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="dealing-with-big-data-in-r.html#cb13-1" aria-hidden="true" tabindex="-1"></a>FUN <span class="ot">&lt;-</span> <span class="cf">function</span>(i) {</span>
<span id="cb13-2"><a href="dealing-with-big-data-in-r.html#cb13-2" aria-hidden="true" tabindex="-1"></a>  ind <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">100</span>, <span class="dv">100</span>, <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb13-3"><a href="dealing-with-big-data-in-r.html#cb13-3" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(Species <span class="sc">~</span> Sepal.Length, <span class="at">family=</span><span class="fu">binomial</span>(logit), <span class="at">data =</span> iris[ind,])</span>
<span id="cb13-4"><a href="dealing-with-big-data-in-r.html#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coefficients</span>(mod)</span>
<span id="cb13-5"><a href="dealing-with-big-data-in-r.html#cb13-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-6"><a href="dealing-with-big-data-in-r.html#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="dealing-with-big-data-in-r.html#cb13-7" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb13-8"><a href="dealing-with-big-data-in-r.html#cb13-8" aria-hidden="true" tabindex="-1"></a>testdata3 <span class="ot">&lt;-</span> <span class="fu">benchmark</span>(<span class="st">&quot;For loop&quot;</span> <span class="ot">=</span> <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(a)){ <span class="fu">FUN</span>(a[[i]])},</span>
<span id="cb13-9"><a href="dealing-with-big-data-in-r.html#cb13-9" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;lapply&quot;</span> <span class="ot">=</span> <span class="fu">lapply</span>(a, <span class="at">FUN =</span> FUN), </span>
<span id="cb13-10"><a href="dealing-with-big-data-in-r.html#cb13-10" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;Foreach dopar&quot;</span> <span class="ot">=</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">%dopar%</span> <span class="fu">FUN</span>(i),</span>
<span id="cb13-11"><a href="dealing-with-big-data-in-r.html#cb13-11" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;Foreach do&quot;</span> <span class="ot">=</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">%do%</span> <span class="fu">FUN</span>(i),</span>
<span id="cb13-12"><a href="dealing-with-big-data-in-r.html#cb13-12" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;parLapply&quot;</span> <span class="ot">=</span> <span class="fu">parLapply</span>(<span class="at">cl =</span> cl, <span class="at">X =</span> a, <span class="at">fun =</span> FUN),</span>
<span id="cb13-13"><a href="dealing-with-big-data-in-r.html#cb13-13" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;parSapply&quot;</span> <span class="ot">=</span> <span class="fu">parSapply</span>(<span class="at">cl =</span> cl, <span class="at">X =</span> a, <span class="at">FUN =</span> FUN),</span>
<span id="cb13-14"><a href="dealing-with-big-data-in-r.html#cb13-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">columns=</span><span class="fu">c</span>(<span class="st">&#39;test&#39;</span>, <span class="st">&#39;elapsed&#39;</span>, <span class="st">&#39;replications&#39;</span>),</span>
<span id="cb13-15"><a href="dealing-with-big-data-in-r.html#cb13-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">replications =</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>, <span class="dv">400</span>, <span class="dv">500</span>))</span>
<span id="cb13-16"><a href="dealing-with-big-data-in-r.html#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="dealing-with-big-data-in-r.html#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb13-18"><a href="dealing-with-big-data-in-r.html#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> replications, <span class="at">y =</span> elapsed, <span class="at">colour =</span> test), <span class="at">data =</span> testdata3)</span></code></pre></div>
<p><img src="fig/unnamed-chunk-6-1.png" width="672" /></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="dealing-with-big-data-in-r.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code></pre></div>
<p>To sum up, generally, <code>parLapply ()</code> perform better than <code>foreach ()</code>. However, for all parallel implementation methods, the increase in terms of efficiency is not proportional to the number of cores being used (Theoretical efficiency).</p>
</div>
</div>
<div id="mapreduce" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> MapReduce</h2>
<p>MapReduce is a programming model and an associated implementation for processing and generating big data sets with a parallel, distributed algorithm on a cluster. A MapReduce program is composed of a map procedure, which performs filtering and sorting (such as sorting students by first name into queues, one queue for each name), and a reduce method, which performs a summary operation (such as counting the number of students in each queue, yielding name frequencies). The “MapReduce System” (also called “infrastructure” or “framework”) orchestrates the processing by marshalling the distributed servers, running the various tasks in parallel, managing all communications and data transfers between the various parts of the system, and providing for redundancy and fault tolerance. The model is a specialization of the split-apply-combine strategy for data analysis. It is inspired by the map and reduce functions commonly used in <a href="https://en.wikipedia.org/wiki/Functional_programming">functional programming</a>. There are two main frameworks to deal with Big Data and where MapReduce can be applied efficiently</p>
<ul>
<li><strong><a href="https://hadoop.apache.org/">Hadoop</a></strong> provides support to perform MapReduce operations over a distributed file system of large data sets across clusters of computers using simple programming models. It is designed to scale up from single servers to thousands of machines, each offering local computation and storage.</li>
<li><strong><a href="https://spark.apache.org/">Spark</a></strong> provides a richer set of verbs beyond MapReduce to facilitate optimizing code running in multiple machines. Spark also loaded data in-memory, making operations much faster than Hadoop’s on-disk storage.</li>
</ul>
<p>Thre are some pacakges to connect R and both <a href="https://datascienceplus.com/integrating-r-with-apache-hadoop/">Hadoop</a> and <a href="https://spark.apache.org/docs/latest/sparkr.html">Spark</a>, but they use is beyond the scope of this short introduction to Big Data analysis.</p>
<p>Next figure illustrate how to use MapReduce to count words in two different text files stored in different machines. The map operation splits each word in the original file and outputs a new word-counting file with a mapping of words and counts. The reduce operation can be defined to take two word-counting files and combine them by aggregating the totals for each word; this last file will contain a list of word counts across all the original files. Counting words is often the most basic MapReduce example, but we can also use MapReduce for much more sophisticated and interesting applications in statistics.</p>
<p><img src="figures/mapreduce.png" style="width:60.0%" alt="MapReduce example counting words across files" />
The MapReduce paradigm has long been a staple of big data computational strategies. However, properly leveraging MapReduce in R can be a challenge, even for experienced users. To get the most out of MapReduce, it is helpful to understand its relationship to functional programming. Functional programming, in a broad sense, is the one that some functions allows to have another function in one of its arguments. For instance, the function <code>sapply()</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="dealing-with-big-data-in-r.html#cb15-1" aria-hidden="true" tabindex="-1"></a>ff <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="cf">if</span>(x <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">log</span>(x) <span class="cf">else</span> <span class="fu">log</span>(<span class="sc">-</span>x)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb15-2"><a href="dealing-with-big-data-in-r.html#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(<span class="sc">-</span><span class="dv">4</span><span class="sc">:</span><span class="dv">10</span>, ff)</span></code></pre></div>
<pre><code> [1] 1.9218121 1.2069490 0.4804530 0.0000000       Inf 0.0000000 0.6931472 1.0986123 1.3862944 1.6094379
[11] 1.7917595 1.9459101 2.0794415 2.1972246 2.3025851</code></pre>
<p>Functional programming is a very powerful tool that allows you to program in the following way:</p>
<ul>
<li>Create small and simple functions that solve a small and bounded problem</li>
<li>Apply these functions to homogeneous groups of values.</li>
</ul>
<p>In the previous example, we have built an <code>ff</code> function and through the <code>sapply ()</code> function we have applied it to a list of homogeneous values: the numbers from -4 to 10.</p>
<p>There are many functions in R, some of which you have already seen, that take others as arguments. Some of the most common are:</p>
<ul>
<li>sapply y lapply</li>
<li>tapply</li>
<li>apply y mapply</li>
<li>Las funciones ddply, ldply, etc. del paquete <code>plyr</code></li>
</ul>
<p>A very common example of this type of functions is used to inspect the type of columns in a table since they take advantage of the fact that a table is a list of columns and go through them one by one</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="dealing-with-big-data-in-r.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(iris, class)</span></code></pre></div>
<pre><code>$Sepal.Length
[1] &quot;numeric&quot;

$Sepal.Width
[1] &quot;numeric&quot;

$Petal.Length
[1] &quot;numeric&quot;

$Petal.Width
[1] &quot;numeric&quot;

$Species
[1] &quot;factor&quot;</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="dealing-with-big-data-in-r.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(iris, length)</span></code></pre></div>
<pre><code>Sepal.Length  Sepal.Width Petal.Length  Petal.Width      Species 
         150          150          150          150          150 </code></pre>
<p>One of the advantages of this type of programming is that the code is shorter and more readable. We must remember that these functions include the argument <code>...</code> that allows to pass additional arguments to the function they call. For example this function would do the same as the previous one, but it would be more generic since it would allow calculations by varying the <code>s</code> argument.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="dealing-with-big-data-in-r.html#cb21-1" aria-hidden="true" tabindex="-1"></a>ff2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x, s) {</span>
<span id="cb21-2"><a href="dealing-with-big-data-in-r.html#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(x <span class="sc">&gt;</span> s) <span class="fu">log</span>(x) <span class="cf">else</span> <span class="fu">log</span>(<span class="sc">-</span>x)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb21-3"><a href="dealing-with-big-data-in-r.html#cb21-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-4"><a href="dealing-with-big-data-in-r.html#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(<span class="sc">-</span><span class="dv">4</span><span class="sc">:</span><span class="dv">10</span>, ff2, <span class="at">s=</span><span class="dv">0</span>)</span></code></pre></div>
<pre><code> [1] 1.9218121 1.2069490 0.4804530 0.0000000       Inf 0.0000000 0.6931472 1.0986123 1.3862944 1.6094379
[11] 1.7917595 1.9459101 2.0794415 2.1972246 2.3025851</code></pre>
<div id="map" class="section level3" number="2.3.1">
<h3><span class="header-section-number">2.3.1</span> Map</h3>
<p>The MapReduce methodology is also implemented in base R (<code>Map ()</code> and <code>Reduce ()</code> functions) as well as in <code>tidyverse</code>. Function <code>Map ()</code> applies one function to all elements from a list o vector:</p>
<p><code>map(YOUR_LIST, YOUR_FUNCTION)</code></p>
<p>Previous operations could also be executed by usint this code (<code>sapply ()</code> es un caso especial de la función <code>Map ()</code>):</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="dealing-with-big-data-in-r.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Map</span>(ff, <span class="fu">c</span>(<span class="dv">9</span>, <span class="dv">16</span>, <span class="dv">25</span>))</span></code></pre></div>
<pre><code>[[1]]
[1] 2.197225

[[2]]
[1] 2.772589

[[3]]
[1] 3.218876</code></pre>
<p>y</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="dealing-with-big-data-in-r.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Map</span>(ff2, <span class="fu">c</span>(<span class="dv">9</span>, <span class="dv">16</span>, <span class="dv">25</span>), <span class="at">s=</span><span class="dv">0</span>)</span></code></pre></div>
<pre><code>[[1]]
[1] 2.197225

[[2]]
[1] 2.772589

[[3]]
[1] 3.218876</code></pre>
<p>Another advantage appears when we want to <strong>vary more than one argument</strong>. With <code>lapply ()</code>, only one argument varies; the others are fixed. For example, how would you find a weighted mean when you have two lists, one of observations and the other of weights?</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="dealing-with-big-data-in-r.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate some sample data</span></span>
<span id="cb27-2"><a href="dealing-with-big-data-in-r.html#cb27-2" aria-hidden="true" tabindex="-1"></a>xs <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">5</span>, <span class="fu">runif</span>(<span class="dv">10</span>), <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb27-3"><a href="dealing-with-big-data-in-r.html#cb27-3" aria-hidden="true" tabindex="-1"></a>ws <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">5</span>, <span class="fu">rpois</span>(<span class="dv">10</span>, <span class="dv">5</span>) <span class="sc">+</span> <span class="dv">1</span>, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb27-4"><a href="dealing-with-big-data-in-r.html#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(xs)</span></code></pre></div>
<pre><code>List of 5
 $ : num [1:10] 0.767 0.671 0.909 0.198 0.436 ...
 $ : num [1:10] 0.296 0.306 0.126 0.518 0.831 ...
 $ : num [1:10] 0.607 0.6956 0.1348 0.0715 0.1021 ...
 $ : num [1:10] 0.655 0.107 0.925 0.557 0.742 ...
 $ : num [1:10] 0.149 0.47 0.668 0.194 0.451 ...</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="dealing-with-big-data-in-r.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(ws)</span></code></pre></div>
<pre><code>List of 5
 $ : num [1:10] 6 3 5 4 8 13 5 5 3 5
 $ : num [1:10] 3 9 6 5 6 4 6 6 6 5
 $ : num [1:10] 3 14 12 4 8 8 4 8 3 4
 $ : num [1:10] 7 7 8 5 9 7 6 6 8 4
 $ : num [1:10] 4 5 7 4 3 4 8 4 4 7</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="dealing-with-big-data-in-r.html#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute the weighted.mean</span></span>
<span id="cb31-2"><a href="dealing-with-big-data-in-r.html#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">unlist</span>(<span class="fu">Map</span>(weighted.mean, xs, ws))</span></code></pre></div>
<pre><code>[1] 0.4676235 0.5447004 0.3928258 0.4760168 0.5505697</code></pre>
<p>If some of the arguments should be fixed and constant, use an anonymous function:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="dealing-with-big-data-in-r.html#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Map</span>(<span class="cf">function</span>(x, w) <span class="fu">weighted.mean</span>(x, w, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), xs, ws)</span></code></pre></div>
<pre><code>[[1]]
[1] 0.4676235

[[2]]
[1] 0.5447004

[[3]]
[1] 0.3928258

[[4]]
[1] 0.4760168

[[5]]
[1] 0.5505697</code></pre>
</div>
<div id="reduce" class="section level3" number="2.3.2">
<h3><span class="header-section-number">2.3.2</span> Reduce</h3>
<p>Another way of thinking about functionals is as a set of general tools for altering, subsetting, and collapsing lists. Every functional programming language has three tools for this: <code>Map()</code>, <code>Reduce()</code>, and <code>Filter()</code>. We have seen <code>Map()</code> already, and next we describe <code>Reduce()</code>, a powerful tool for extending two-argument functions. <code>Filter()</code> is a member of an important class of functionals that work with predicates, functions that return a single TRUE or FALSE (we will not cover that).</p>
<p><code>Reduce()</code> reduces a vector, x, to a single value by recursively calling a function, f, two arguments at a time. It combines the first two elements with f, then combines the result of that call with the third element, and so on. Calling <code>Reduce(f, 1:3)</code> is equivalent to <code>f(f(1, 2), 3)</code>. Reduce is also known as fold, because it folds together adjacent elements in the list.</p>
<p>The following two examples show what Reduce does with an infix and prefix function:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="dealing-with-big-data-in-r.html#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Reduce</span>(<span class="st">`</span><span class="at">+</span><span class="st">`</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="co"># -&gt; ((1 + 2) + 3)</span></span></code></pre></div>
<pre><code>[1] 6</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="dealing-with-big-data-in-r.html#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Reduce</span>(sum, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="co"># -&gt; sum(sum(1, 2), 3)</span></span></code></pre></div>
<pre><code>[1] 6</code></pre>
<p>The essence of <code>Reduce()</code> can be described by a simple for loop:</p>
<pre><code>Reduce2 &lt;- function(f, x) {
  out &lt;- x[[1]]
  for(i in seq(2, length(x))) {
    out &lt;- f(out, x[[i]])
  }
  out
}</code></pre>
<p><code>Reduce()</code> is also an elegant way of extending a function that works with two inputs into a function that can deal with any number of inputs. It is useful for implementing many types of recursive operations, like merges and intersections. Imagine you have a list of numeric vectors, and you want to find the values that occur in every element:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="dealing-with-big-data-in-r.html#cb40-1" aria-hidden="true" tabindex="-1"></a>l <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">5</span>, <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">15</span>, <span class="at">replace =</span> T), <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb40-2"><a href="dealing-with-big-data-in-r.html#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(l)</span></code></pre></div>
<pre><code>List of 5
 $ : int [1:15] 9 7 9 6 6 6 10 4 3 8 ...
 $ : int [1:15] 8 3 7 1 9 5 3 8 10 7 ...
 $ : int [1:15] 8 6 9 8 9 3 9 10 9 4 ...
 $ : int [1:15] 7 4 10 8 6 6 3 7 6 4 ...
 $ : int [1:15] 10 7 8 10 5 1 6 9 6 8 ...</code></pre>
<p>You could do that by intersecting each element in turn:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="dealing-with-big-data-in-r.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">intersect</span>(<span class="fu">intersect</span>(<span class="fu">intersect</span>(<span class="fu">intersect</span>(l[[<span class="dv">1</span>]], l[[<span class="dv">2</span>]]),</span>
<span id="cb42-2"><a href="dealing-with-big-data-in-r.html#cb42-2" aria-hidden="true" tabindex="-1"></a>                              l[[<span class="dv">3</span>]]), l[[<span class="dv">4</span>]]), l[[<span class="dv">5</span>]])</span></code></pre></div>
<pre><code>[1]  9  6 10  8</code></pre>
<p>That’s hard to read. With <code>Reduce()</code>, the equivalent is:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="dealing-with-big-data-in-r.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Reduce</span>(intersect, l)</span></code></pre></div>
<pre><code>[1]  9  6 10  8</code></pre>
</div>
</div>
<div id="linear-regression-for-big-data" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> Linear regression for Big Data</h2>
<p>In this section, we describe a very nice application of MapReduce framework to a Big Data problem.</p>
<p>There are several problems that require the analysis of large volumes of information. The analysis at very large scale of data is a challenging task since the available information cannot be practically analyzed on a single machine due to the sheer size of the data to fit in memory. In order to overcome this difficulty, high-performance analytical systems running on distributed environments can be used. To this end standard analytics algorithms need to be adapted to take advantage of cloud computing models which provide scalability and flexibility. Here, we describe an approach that introduces a new distributed training method for Multiple Linear Regression which will be based on the QR decomposition and the ordinary least squares method adapted to MapReduce framework. The method is called MLR-MR and is described in (<a href="https://ieeexplore.ieee.org/document/7345473">Moufida Adjout Rehab and Faouzi Boufares, 2105</a>). The paper is also available in our Moodle.</p>
<p>In this figure we can observe as the model fitting using MLR-MR algorithm is dramatically reduced when the number of MapReduce processors increases.</p>
<div class="figure">
<img src="figures/MLR-MR_time.png" style="width:50.0%" alt="" />
<p class="caption">Speedup training MLR-MR with different MapReduce working nodes</p>
</div>
<p>Let us start by recalling how to describe linear regression using the classical matrix notation:</p>
<p><span class="math display">\[\mathbf{Y}=\mathbf{X}\mathbf{\beta}+\mathbf{\varepsilon}.\]</span></p>
<p>The ordinary least square (OLS) estimate of <span class="math inline">\(\mathbf{\beta}\)</span> is <span class="math display">\[\widehat{\mathbf{\beta}}=[\mathbf{X}^T\mathbf{X}]^{-1}\mathbf{X}^T\mathbf{y}\]</span>. To illustrate, let us consider the “mtcars” example, and run this regression:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="dealing-with-big-data-in-r.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(mtcars)</span>
<span id="cb46-2"><a href="dealing-with-big-data-in-r.html#cb46-2" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> (<span class="fu">lm</span>(mpg <span class="sc">~</span> wt <span class="sc">+</span> cyl, <span class="at">data =</span> mtcars))</span></code></pre></div>
<p>The algorithm implemented in the <code>lm ()</code> function uses the QR decomposition of <span class="math inline">\(\mathbf{X},\)</span> <span class="math display">\[\mathbf{X}=\mathbf{Q}\mathbf{R},\]</span> where <span class="math inline">\(\mathbf{Q}\)</span> is an orthogonal matrix (i.e. <span class="math inline">\(\mathbf{Q}^T\mathbf{Q}=\mathbb{I}\)</span>).Then,</p>
<p><span class="math display">\[\widehat{\mathbf{\beta}}=[\mathbf{X}^T\mathbf{X}]^{-1}\mathbf{X}^T\mathbf{y}=\mathbf{R}^{-1}\mathbf{Q}^T\mathbf{y}\]</span></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="dealing-with-big-data-in-r.html#cb47-1" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> mtcars<span class="sc">$</span>mpg</span>
<span id="cb47-2"><a href="dealing-with-big-data-in-r.html#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co">#similar to cbind(1, mtcars$wt, mtcars$cyl)</span></span>
<span id="cb47-3"><a href="dealing-with-big-data-in-r.html#cb47-3" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> wt <span class="sc">+</span> cyl, <span class="at">data=</span>mtcars)</span>
<span id="cb47-4"><a href="dealing-with-big-data-in-r.html#cb47-4" aria-hidden="true" tabindex="-1"></a>QR <span class="ot">&lt;-</span> <span class="fu">qr</span>(<span class="fu">as.matrix</span>(X))</span>
<span id="cb47-5"><a href="dealing-with-big-data-in-r.html#cb47-5" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="fu">qr.R</span>(QR)</span>
<span id="cb47-6"><a href="dealing-with-big-data-in-r.html#cb47-6" aria-hidden="true" tabindex="-1"></a>Q <span class="ot">&lt;-</span> <span class="fu">qr.Q</span>(QR)</span>
<span id="cb47-7"><a href="dealing-with-big-data-in-r.html#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="fu">solve</span>(R) <span class="sc">%*%</span> <span class="fu">t</span>(Q) <span class="sc">%*%</span> Y</span></code></pre></div>
<pre><code>                 [,1]
(Intercept) 39.686261
wt          -3.190972
cyl         -1.507795</code></pre>
<p>We can parallelise computations using the MLR-MR method as follows:</p>
<p>Consider <span class="math inline">\(m\)</span> blocks, for instance 3 (given tha we have 4 cores)</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="dealing-with-big-data-in-r.html#cb49-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">3</span></span></code></pre></div>
<p>and split vectors and matrices</p>
<p><span class="math display">\[\mathbf{y}=\left[\begin{matrix}\mathbf{y}_1\\\mathbf{y}_2\\\vdots \\\mathbf{y}_m\end{matrix}\right]\]</span></p>
<p>and</p>
<p><span class="math display">\[\mathbf{X}=\left[\begin{matrix}\mathbf{X}_1\\\mathbf{X}_2\\\vdots\\\mathbf{X}_m\end{matrix}\right]=\left[\begin{matrix}\mathbf{Q}_1^{(1)}\mathbf{R}_1^{(1)}\\\mathbf{Q}_2^{(1)}\mathbf{R}_2^{(1)}\\\vdots \\\mathbf{Q}_m^{(1)}\mathbf{R}_m^{(1)}\end{matrix}\right]\]</span></p>
<p>In R to split vectors and matrices we can use these two functions:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="dealing-with-big-data-in-r.html#cb50-1" aria-hidden="true" tabindex="-1"></a>chunk <span class="ot">&lt;-</span> <span class="cf">function</span>(x,n) <span class="fu">split</span>(x, <span class="fu">cut</span>(<span class="fu">seq_along</span>(x), n, <span class="at">labels =</span> <span class="cn">FALSE</span>)) </span>
<span id="cb50-2"><a href="dealing-with-big-data-in-r.html#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="dealing-with-big-data-in-r.html#cb50-3" aria-hidden="true" tabindex="-1"></a>splitMatByRow <span class="ot">=</span> <span class="cf">function</span>(mat, size){</span>
<span id="cb50-4"><a href="dealing-with-big-data-in-r.html#cb50-4" aria-hidden="true" tabindex="-1"></a>  row.index <span class="ot">&lt;-</span> <span class="fu">chunk</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mat), size)</span>
<span id="cb50-5"><a href="dealing-with-big-data-in-r.html#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(row.index, <span class="cf">function</span>(val) mat[val, ])</span>
<span id="cb50-6"><a href="dealing-with-big-data-in-r.html#cb50-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We can do that with our data</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="dealing-with-big-data-in-r.html#cb51-1" aria-hidden="true" tabindex="-1"></a>x.block <span class="ot">&lt;-</span> <span class="fu">splitMatByRow</span>(X, m)</span>
<span id="cb51-2"><a href="dealing-with-big-data-in-r.html#cb51-2" aria-hidden="true" tabindex="-1"></a>y.block <span class="ot">&lt;-</span> <span class="fu">splitMatByRow</span>(<span class="fu">matrix</span>(Y, <span class="at">ncol =</span> <span class="dv">1</span>), m)</span></code></pre></div>
<p>Then, we get small QR decomposition (per subset). This step correspond to de <strong>Map</strong> step in the <code>MapReduce</code> framework</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="dealing-with-big-data-in-r.html#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Algorithm 2 Mapper function in step1</span></span>
<span id="cb52-2"><a href="dealing-with-big-data-in-r.html#cb52-2" aria-hidden="true" tabindex="-1"></a>x.block.qr <span class="ot">&lt;-</span> <span class="fu">lapply</span>(x.block, <span class="cf">function</span>(val){</span>
<span id="cb52-3"><a href="dealing-with-big-data-in-r.html#cb52-3" aria-hidden="true" tabindex="-1"></a>  qrresult <span class="ot">&lt;-</span> <span class="fu">qr</span>(val)</span>
<span id="cb52-4"><a href="dealing-with-big-data-in-r.html#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Q=</span><span class="fu">qr.Q</span>(qrresult), <span class="at">R=</span><span class="fu">qr.R</span>(qrresult))</span>
<span id="cb52-5"><a href="dealing-with-big-data-in-r.html#cb52-5" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Now, consider the QR decomposition of <span class="math inline">\(\mathbf{R}^{(1)}\)</span> which is the first step of the reduce part</p>
<p><span class="math display">\[\mathbf{R}^{(1)}=\left[\begin{matrix}\mathbf{R}_1^{(1)}\\\mathbf{R}_2^{(1)}\\\vdots \\\mathbf{R}_m^{(1)}\end{matrix}\right]=\mathbf{Q}^{(2)}\mathbf{R}^{(2)}\]</span> where</p>
<p><span class="math display">\[\mathbf{Q}^{(2)}=\left[\begin{matrix}\mathbf{Q}^{(2)}_1\\\mathbf{Q}^{(2)}_2\\\vdots\\\mathbf{Q}^{(2)}_m\end{matrix}\right]\]</span></p>
<p>that can be computed as</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="dealing-with-big-data-in-r.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Algorithm 3 Reducer function in step1</span></span>
<span id="cb53-2"><a href="dealing-with-big-data-in-r.html#cb53-2" aria-hidden="true" tabindex="-1"></a>Rtemp <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(x.block.qr, <span class="cf">function</span> (l) l<span class="sc">$</span>R))</span>
<span id="cb53-3"><a href="dealing-with-big-data-in-r.html#cb53-3" aria-hidden="true" tabindex="-1"></a>qrresult <span class="ot">&lt;-</span> <span class="fu">qr</span>(Rtemp)</span>
<span id="cb53-4"><a href="dealing-with-big-data-in-r.html#cb53-4" aria-hidden="true" tabindex="-1"></a>Rtemp.qr <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Q=</span><span class="fu">qr.Q</span>(qrresult), <span class="at">R=</span><span class="fu">qr.R</span>(qrresult))</span>
<span id="cb53-5"><a href="dealing-with-big-data-in-r.html#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="dealing-with-big-data-in-r.html#cb53-6" aria-hidden="true" tabindex="-1"></a>R.final <span class="ot">&lt;-</span> Rtemp.qr<span class="sc">$</span>R</span>
<span id="cb53-7"><a href="dealing-with-big-data-in-r.html#cb53-7" aria-hidden="true" tabindex="-1"></a>Rtemp.Q.divide <span class="ot">&lt;-</span> <span class="fu">splitMatByRow</span>(Rtemp.qr<span class="sc">$</span>Q, m)</span>
<span id="cb53-8"><a href="dealing-with-big-data-in-r.html#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="dealing-with-big-data-in-r.html#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="dealing-with-big-data-in-r.html#cb53-10" aria-hidden="true" tabindex="-1"></a>Q.result <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb53-11"><a href="dealing-with-big-data-in-r.html#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m){</span>
<span id="cb53-12"><a href="dealing-with-big-data-in-r.html#cb53-12" aria-hidden="true" tabindex="-1"></a>  Q.result[[i]] <span class="ot">&lt;-</span> x.block.qr[[i]]<span class="sc">$</span>Q <span class="sc">%*%</span> Rtemp.Q.divide[[i]]</span>
<span id="cb53-13"><a href="dealing-with-big-data-in-r.html#cb53-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Define – as step 2 of the reduce part</p>
<p><span class="math display">\[\mathbf{Q}^{(3)}_j=\mathbf{Q}^{(2)}_j\mathbf{Q}^{(1)}_j\]</span></p>
<p>and</p>
<p><span class="math display">\[\mathbf{V}_j=\mathbf{Q}^{(3)T}_j\mathbf{y}_j\]</span></p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="dealing-with-big-data-in-r.html#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Algorithm 4 Reduce function in step2</span></span>
<span id="cb54-2"><a href="dealing-with-big-data-in-r.html#cb54-2" aria-hidden="true" tabindex="-1"></a>V <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb54-3"><a href="dealing-with-big-data-in-r.html#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m){</span>
<span id="cb54-4"><a href="dealing-with-big-data-in-r.html#cb54-4" aria-hidden="true" tabindex="-1"></a>  V[[i]]  <span class="ot">&lt;-</span>  <span class="fu">crossprod</span>(Q.result[[i]], y.block[[i]])  </span>
<span id="cb54-5"><a href="dealing-with-big-data-in-r.html#cb54-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>and finally set – as the step 3 of the reduce part</p>
<p><span class="math display">\[\widehat{\mathbf{\beta}}=[\mathbf{R}^{(2)}]^{-1}\sum_{j=1}^m\mathbf{V}_j\]</span></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="dealing-with-big-data-in-r.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Algorithm 5 Reduce function in step3</span></span>
<span id="cb55-2"><a href="dealing-with-big-data-in-r.html#cb55-2" aria-hidden="true" tabindex="-1"></a>V.sum <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="st">&#39;+&#39;</span>, V)</span>
<span id="cb55-3"><a href="dealing-with-big-data-in-r.html#cb55-3" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">solve</span>(R.final) <span class="sc">%*%</span> V.sum)</span></code></pre></div>
<p>Let us compare the results</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="dealing-with-big-data-in-r.html#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">lm=</span><span class="fu">coef</span>(mod), <span class="at">parallel=</span>beta)</span></code></pre></div>
<pre><code>                   lm  parallel
(Intercept) 39.686261 39.686261
wt          -3.190972 -3.190972
cyl         -1.507795 -1.507795</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="dealing-with-big-data-in-r.html#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># error</span></span>
<span id="cb58-2"><a href="dealing-with-big-data-in-r.html#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>((beta <span class="sc">-</span> <span class="fu">coef</span>(mod)) <span class="sc">**</span> <span class="dv">2</span>)</span></code></pre></div>
<pre><code>[1] 2.607678e-28</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="linear-models.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/isglobal-brge/Aprendizaje_Automatico_1/tree/master/docs01-paralelizacion.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
